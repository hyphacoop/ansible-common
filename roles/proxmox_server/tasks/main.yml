---
- name: "Install python"
  apt:
    name:
      - python3-pip
      - python3
    state: present

- name: "Adding all nodes to hosts file"
  become: true
  lineinfile:
    path: /etc/hosts
    regexp: "{{ item }}$"
    line: "{{ proxmox_server[item]['ip_address'] }} {{ item }}"
  with_items: "{{ proxmox_server }}"

- name: Allow root login via SSH
  become: true
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PermitRootLogin.*"
    line: "PermitRootLogin yes"
    validate: "/usr/sbin/sshd -tf %s"
    backup: true
  register: ssh_harden_root
  when: ansible_user != "root"

- name: Download proxmox Key
  ansible.builtin.get_url:
    url: https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg
    dest: /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg
    mode: '0666'

- name: "Install proxmox repo"
  ansible.builtin.apt_repository:
    repo: deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
    state: present

- name: Install Proxmox
  apt:
    name:
      - proxmox-ve 
      - postfix 
      - open-iscsi 
      - ifupdown2 
      - smartmontools 
      - htop 
      - vim

- name: "Install proxmoxer"
  pip:
    name: proxmoxer>=1.3.1,<1.4.0
  environment:
    PIP_BREAK_SYSTEM_PACKAGES: "1"

- name: "Set KVM Credentials"
  set_fact:
    proxmox_api_host: "{{proxmox_server[inventory_hostname]['api_host'] }}"
    proxmox_api_password: "{{proxmox_server[inventory_hostname]['api_password'] }}"
    proxmox_api_user: "{{proxmox_server[inventory_hostname]['api_user'] }}"

# Remove subscription warning
- name: Remove subcription warning replace
  replace:
    path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
    regexp: ".data.status.toLowerCase\\(\\) !== 'active'\\) "
    replace: ".data.status !== 'active') if (false) "
    backup: yes

- name: Restart postfix
  ansible.builtin.systemd:
    state: restarted
    enabled: true
    name: pveproxy

- name: Disable VRFY and EXPN in mail server
  lineinfile:
    path: /etc/postfix/main.cf
    regexp: '^disable_vrfy_command'
    line: 'disable_vrfy_command=yes'
    state: present

- name: Securing SSL/TLS to V1.2
  lineinfile:
    path: /etc/postfix/main.cf
    regexp: "^{{ item }}"
    line: "{{ item }}=!SSLv2, !SSLv3, !TLSv1, !TLSv1.1"
    state: present
  loop:
    - smtpd_tls_mandatory_protocols
    - smtpd_tls_protocols
    - smtp_tls_mandatory_protocols
    - smtp_tls_protocols


- name: Restart postfix
  ansible.builtin.systemd:
    state: restarted
    enabled: true
    name: postfix
